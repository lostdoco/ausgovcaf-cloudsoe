{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "policyName": {
      "type": "string"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Authorization/policyDefinitions",
      "name": "[parameters('policyName')]",
      "apiVersion": "2019-09-01",
      "properties": {
        "displayName": "GC - Windows logon Banner",
        "policyType": "Custom",
        "mode": "Indexed",
        "description": "Audit if the Windows logon banner complies with the specified banner text and title.",
        "metadata": {
          "version": "1.0.0",
          "category": "Guest Configuration",
          "guestConfiguration": {
            "name": "WindowsLogonBanner",
            "version": "1.0.0",
            "contentType": "Custom",
            "contentUri": "https://cloudsoegcpol.blob.core.windows.net/guest-config/WindowsLogonBanner.zip?sv=2019-07-07&sr=b&sig=GEhWAE94zx1SZVHqj8mavVYt%2FnVa%2BRs3Yb3EU%2FrI0vQ%3D&st=2021-08-24T13%3A32%3A30Z&se=2024-08-24T13%3A32%3A30Z&sp=rl",
            "contentHash": "E5FB3D6B379C8E6BC69254C7C34F733ECFA52C43B60BD024184C716D17308480",
            "configurationParameter": {
              "BannerTitle": "[Registry]Ensure Windows logon banner title is set correctly;ValueData",
              "BannerText": "[Registry]Ensure Windows logon banner text is set correctly;ValueData"
            }
          },
          "requiredProviders": [
            "Microsoft.GuestConfiguration"
          ]
        },
        "parameters": {
          "BannerTitle": {
            "metadata": {
              "displayName": "Windows logon banner title",
              "description": "Windows logon banner title"
            },
            "defaultValue": "YOUR LOGON BANNER TITLE HERE",
            "type": "string"
          },
          "BannerText": {
            "metadata": {
              "displayName": "Windows logon banner text",
              "description": "Windows logon banner text"
            },
            "defaultValue": "YOUR LOGON BANNER TEXT HERE",
            "type": "string"
          },
          "IncludeArcMachines": {
            "type": "string",
            "metadata": {
              "displayName": "Include Arc connected servers",
              "description": "By selecting this option, you agree to be charged monthly per Arc connected machine."
            },
            "allowedValues": [
              "True",
              "False"
            ],
            "defaultValue": "False"
          }
        },
        "policyRule": {
          "if": {
            "anyOf": [
              {
                "allOf": [
                  {
                    "field": "type",
                    "equals": "Microsoft.Compute/virtualMachines"
                  },
                  {
                    "anyOf": [
                      {
                        "field": "Microsoft.Compute/imagePublisher",
                        "in": [
                          "esri",
                          "incredibuild",
                          "MicrosoftDynamicsAX",
                          "MicrosoftSharepoint",
                          "MicrosoftVisualStudio",
                          "MicrosoftWindowsDesktop",
                          "MicrosoftWindowsServerHPCPack"
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "MicrosoftWindowsServer"
                          },
                          {
                            "field": "Microsoft.Compute/imageSKU",
                            "notLike": "2008*"
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "MicrosoftSQLServer"
                          },
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "notLike": "SQL2008*"
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "microsoft-dsvm"
                          },
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "equals": "dsvm-windows"
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "microsoft-ads"
                          },
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "in": [
                              "standard-data-science-vm",
                              "windows-data-science-vm"
                            ]
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "batch"
                          },
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "equals": "rendering-windows2016"
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "center-for-internet-security-inc"
                          },
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "like": "cis-windows-server-201*"
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "pivotal"
                          },
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "like": "bosh-windows-server*"
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "field": "Microsoft.Compute/imagePublisher",
                            "equals": "cloud-infrastructure-services"
                          },
                          {
                            "field": "Microsoft.Compute/imageOffer",
                            "like": "ad*"
                          }
                        ]
                      },
                      {
                        "allOf": [
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/virtualMachines/osProfile.windowsConfiguration",
                                "exists": "true"
                              },
                              {
                                "field": "Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType",
                                "like": "Windows*"
                              }
                            ]
                          },
                          {
                            "anyOf": [
                              {
                                "field": "Microsoft.Compute/imageSKU",
                                "exists": "false"
                              },
                              {
                                "allOf": [
                                  {
                                    "field": "Microsoft.Compute/imageSKU",
                                    "notLike": "2008*"
                                  },
                                  {
                                    "field": "Microsoft.Compute/imageOffer",
                                    "notLike": "SQL2008*"
                                  }
                                ]
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              },
              {
                "allOf": [
                  {
                    "value": "[[parameters('IncludeArcMachines')]",
                    "equals": "true"
                  },
                  {
                    "field": "type",
                    "equals": "Microsoft.HybridCompute/machines"
                  },
                  {
                    "field": "Microsoft.HybridCompute/imageOffer",
                    "like": "windows*"
                  }
                ]
              }
            ]
          },
          "then": {
            "effect": "deployIfNotExists",
            "details": {
              "type": "Microsoft.GuestConfiguration/guestConfigurationAssignments",
              "name": "WindowsLogonBanner",
              "roleDefinitionIds": [
                "/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c"
              ],
              "existenceCondition": {
                "allOf": [
                  {
                    "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/parameterHash",
                    "equals": "[base64(concat('[Registry]Ensure Windows logon banner title is set correctly;ValueData', '=', parameters('BannerTitle'), ',', '[Registry]Ensure Windows logon banner text is set correctly;ValueData', '=', parameters('BannerText')))]"
                  },
                  {
                    "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/contentHash",
                    "equals": "[E5FB3D6B379C8E6BC69254C7C34F733ECFA52C43B60BD024184C716D17308480"
                  },
                  {
                    "field": "Microsoft.GuestConfiguration/guestConfigurationAssignments/complianceStatus",
                    "equals": "Compliant"
                  }
                ]
              },
              "deployment": {
                "properties": {
                  "mode": "incremental",
                  "parameters": {
                    "vmName": {
                      "value": "[field('name')]"
                    },
                    "location": {
                      "value": "[field('location')]"
                    },
                    "type": {
                      "value": "[field('type')]"
                    },
                    "configurationName": {
                      "value": "WindowsLogonBanner"
                    },
                    "contentUri": {
                      "value": "https://cloudsoegcpol.blob.core.windows.net/guest-config/WindowsLogonBanner.zip?sv=2019-07-07&sr=b&sig=GEhWAE94zx1SZVHqj8mavVYt%2FnVa%2BRs3Yb3EU%2FrI0vQ%3D&st=2021-08-24T13%3A32%3A30Z&se=2024-08-24T13%3A32%3A30Z&sp=rl"
                    },
                    "contentHash": {
                      "value": "E5FB3D6B379C8E6BC69254C7C34F733ECFA52C43B60BD024184C716D17308480"
                    },
                    "BannerTitle": {
                      "value": "[parameters('BannerTitle')]"
                    },
                    "BannerText": {
                      "value": "[parameters('BannerText')]"
                    }
                  },
                  "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                      "vmName": {
                        "type": "string"
                      },
                      "location": {
                        "type": "string"
                      },
                      "type": {
                        "type": "string"
                      },
                      "configurationName": {
                        "type": "string"
                      },
                      "contentUri": {
                        "type": "string"
                      },
                      "contentHash": {
                        "type": "string"
                      },
                      "BannerTitle": {
                        "type": "string"
                      },
                      "BannerText": {
                        "type": "string"
                      }
                    },
                    "resources": [
                      {
                        "condition": "[equals(toLower(parameters('type')), toLower('Microsoft.Compute/virtualMachines'))]",
                        "apiVersion": "2018-11-20",
                        "type": "Microsoft.Compute/virtualMachines/providers/guestConfigurationAssignments",
                        "name": "[concat(parameters('vmName'), '/Microsoft.GuestConfiguration/', parameters('configurationName'))]",
                        "location": "[parameters('location')]",
                        "properties": {
                          "guestConfiguration": {
                            "name": "[parameters('configurationName')]",
                            "version": "1.0.0",
                            "contentUri": "[parameters('contentUri')]",
                            "contentHash": "[parameters('contentHash')]",
                            "assignmentType": "ApplyAndMonitor",
                            "configurationParameter": [
                              {
                                "name": "[Registry]Ensure Windows logon banner title is set correctly;ValueData",
                                "value": "[parameters('BannerTitle')]"
                              },
                              {
                                "name": "[Registry]Ensure Windows logon banner text is set correctly;ValueData",
                                "value": "[parameters('BannerText')]"
                              }
                            ]
                          }
                        }
                      },
                      {
                        "condition": "[equals(toLower(parameters('type')), toLower('microsoft.hybridcompute/machines'))]",
                        "apiVersion": "2018-11-20",
                        "type": "Microsoft.HybridCompute/machines/providers/guestConfigurationAssignments",
                        "name": "[concat(parameters('vmName'), '/Microsoft.GuestConfiguration/', parameters('configurationName'))]",
                        "location": "[parameters('location')]",
                        "properties": {
                          "guestConfiguration": {
                            "name": "[parameters('configurationName')]",
                            "contentUri": "[parameters('contentUri')]",
                            "contentHash": "[parameters('contentHash')]",
                            "assignmentType": "ApplyAndMonitor",
                            "version": "1.0.0",
                            "configurationParameter": [
                              {
                                "name": "[Registry]Ensure Windows logon banner title is set correctly;ValueData",
                                "value": "[parameters('BannerTitle')]"
                              },
                              {
                                "name": "[Registry]Ensure Windows logon banner text is set correctly;ValueData",
                                "value": "[parameters('BannerText')]"
                              }
                            ]
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "policyDefinitionId": {
      "type": "string",
      "value": "[resourceId('Microsoft.Authorization/policyDefinitions',parameters('policyName'))]"
    }
  }
}
